<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Scan</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* BASE RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* TOP HEADER (White) */
        .header { background: white; padding: 10px; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* 2x2 STATS GRID */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-card { background: #f8fafc; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-card.batch { background: #eff6ff; border-color: #bfdbfe; }
        .stat-val { font-size: 1.2rem; font-weight: 800; color: #0f172a; line-height: 1; }
        .stat-label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: 600; margin-top: 4px; }
        
        /* MODE TABS */
        .tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 3px; }
        .tab { flex: 1; padding: 10px; text-align: center; font-weight: 700; font-size: 0.85rem; border-radius: 6px; cursor: pointer; transition: 0.2s; color: #64748b; }
        .tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #000; }
        .tab[data-mode="READY"].active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .tab[data-mode="PICKED_UP"].active { color: #16a34a; border-bottom: 3px solid #16a34a; }

        /* CAMERA AREA (Flexible Middle) */
        #reader-container { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        /* CUSTOM VIEWFINDER (Green Box) */
        .viewfinder {
            position: absolute; width: 70%; height: 30%;
            border: 4px solid rgba(37, 235, 50, 0.6);
            border-radius: 10px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5); /* Dim surroundings */
            pointer-events: none; z-index: 10;
        }
        .viewfinder::after {
            content: "SCAN HERE"; position: absolute; top: -25px; left: 0; right: 0;
            text-align: center; color: white; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px;
            text-shadow: 0 1px 2px black;
        }

        /* LOGS AREA (Bottom Slider - Increased Size) */
        .logs-container { 
            height: 35vh; /* 35% of screen height */
            background: white; 
            border-top-left-radius: 15px; border-top-right-radius: 15px; 
            display: flex; flex-direction: column; 
            z-index: 20; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }
        .logs-header { 
            padding: 10px 15px; border-bottom: 1px solid #e2e8f0; 
            font-size: 0.8rem; font-weight: bold; color: #475569; display: flex; justify-content: space-between; 
        }
        .logs-list { 
            flex: 1; overflow-y: auto; padding: 0; margin: 0; 
        }
        .log-row { 
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .log-row.ok { border-left: 5px solid #16a34a; background: #f0fdf4; }
        .log-row.err { border-left: 5px solid #dc2626; background: #fef2f2; }
        .log-awb { font-weight: bold; font-size: 1rem; color: #1e293b; }
        .log-msg { font-size: 0.8rem; color: #64748b; margin-top: 2px; }
        .log-time { font-size: 0.7rem; color: #94a3b8; }

        /* BATCH RESET BUTTON */
        .btn-reset { border: 1px solid #cbd5e1; background: white; border-radius: 4px; padding: 2px 8px; font-size: 0.7rem; color: #64748b; }

        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .overlay.success { background: rgba(22, 163, 74, 0.95); }
        .overlay.error { background: rgba(220, 38, 38, 0.98); color: white; }
        .overlay h1 { font-size: 4rem; margin: 0; }
        .overlay p { color: white; font-size: 1.5rem; font-weight: bold; margin: 10px 20px; }
        button.btn-close { margin-top: 20px; padding: 15px 40px; border-radius: 30px; border: none; font-weight: bold; font-size: 1.1rem; background: white; color: black; }

    </style>
</head>
<body>

    <div class="header">
        <div class="stats-grid">
            <div class="stat-card batch">
                <div class="stat-val" id="b-ready">0</div>
                <div class="stat-label">Batch Ready</div>
            </div>
            <div class="stat-card batch">
                <div class="stat-val" id="b-picked">0</div>
                <div class="stat-label">Batch Picked</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="t-ready">-</div>
                <div class="stat-label">Today Ready</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="t-picked">-</div>
                <div class="stat-label">Today Picked</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-mode="READY" onclick="setMode('READY')">MARK READY</div>
            <div class="tab" data-mode="PICKED_UP" onclick="setMode('PICKED_UP')">MARK PICKED UP</div>
        </div>
    </div>

    <div id="reader-container">
        <div id="reader"></div>
        <div class="viewfinder"></div> </div>

    <div class="logs-container">
        <div class="logs-header">
            <span>PREVIOUS SCANS</span>
            <button class="btn-reset" onclick="resetBatch()">RESET BATCH</button>
        </div>
        <div class="logs-list" id="logs">
            </div>
    </div>

    <div id="success-overlay" class="overlay success">
        <h1>✅</h1>
        <p id="success-txt">Scanned</p>
    </div>

    <div id="error-overlay" class="overlay error">
        <h1>⚠️</h1>
        <p id="error-txt">Error</p>
        <button class="btn-close" onclick="closeError()">OK</button>
    </div>

    <script>
        // === CONFIG ===
        const BASE_URL = "https://pzgnggkanppnwnkjgwrm.supabase.co/functions/v1"; 
        const OPERATOR = "WarehouseOps";
        
        // === STATE ===
        let MODE = 'READY';
        let isProcessing = false;
        let lastCode = null;
        let batch = { READY: 0, PICKED_UP: 0 };
        let today = { READY: 0, PICKED_UP: 0 };

        // === AUDIO ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'ok') {
                osc.frequency.value = 1000; gain.gain.value = 0.1;
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else {
                osc.type = 'sawtooth'; osc.frequency.value = 150; gain.gain.value = 0.5;
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                if(navigator.vibrate) navigator.vibrate(200);
            }
        }

        // === UI LOGIC ===
        function setMode(m) {
            MODE = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-mode="${m}"]`).classList.add('active');
            lastCode = null;
        }

        function resetBatch() {
            if(confirm("Reset batch counts?")) {
                batch = { READY: 0, PICKED_UP: 0 };
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('b-ready').innerText = batch.READY;
            document.getElementById('b-picked').innerText = batch.PICKED_UP;
            document.getElementById('t-ready').innerText = today.READY;
            document.getElementById('t-picked').innerText = today.PICKED_UP;
        }

        function addLog(awb, msg, type) {
            const row = document.createElement('div');
            row.className = `log-row ${type}`;
            row.innerHTML = `
                <div>
                    <div class="log-awb">${awb}</div>
                    <div class="log-msg">${msg}</div>
                </div>
                <div class="log-time">${new Date().toLocaleTimeString()}</div>
            `;
            document.getElementById('logs').prepend(row);
        }

        // === API LOGIC ===
        async function fetchCounts() {
            try {
                const res = await fetch(`${BASE_URL}/warehouse_get_counts`);
                const data = await res.json();
                if(data) {
                    today.READY = data.ready_today || 0;
                    today.PICKED_UP = data.picked_today || 0;
                    updateUI();
                }
            } catch(e) { console.error("Fetch counts failed", e); }
        }

        async function onScan(decodedText) {
            if (isProcessing) return;
            if (decodedText === lastCode) return;
            
            isProcessing = true;
            lastCode = decodedText;

            const endpoint = MODE === 'READY' ? 'warehouse_scan_ready' : 'warehouse_scan_picked_up';
            
            try {
                const res = await fetch(`${BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ awb: decodedText, operator: OPERATOR })
                });
                const data = await res.json();

                if (data.result === 'ACCEPTED') {
                    // Success
                    beep('ok');
                    batch[MODE]++;
                    today[MODE]++; // Optimistic update
                    updateUI();
                    
                    document.getElementById('success-txt').innerText = `${decodedText}\n${data.message}`;
                    document.getElementById('success-overlay').style.display = 'flex';
                    addLog(decodedText, data.message, 'ok');
                    
                    // Re-fetch accurate counts from server in background
                    fetchCounts();

                    setTimeout(() => {
                        document.getElementById('success-overlay').style.display = 'none';
                        isProcessing = false;
                    }, 800);
                } else {
                    // Error
                    throw new Error(data.message);
                }
            } catch (e) {
                beep('err');
                document.getElementById('error-txt').innerText = `${decodedText}\n\n${e.message || "Error"}`;
                document.getElementById('error-overlay').style.display = 'flex';
                addLog(decodedText, e.message || "Error", 'err');
            }
        }

        function closeError() {
            document.getElementById('error-overlay').style.display = 'none';
            isProcessing = false;
            lastCode = null; // Allow retry
        }

        // === INIT ===
        window.onload = function() {
            fetchCounts();
            
            const html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 15, 
                qrbox: { width: 300, height: 150 }, // Wide box for AWBs
                aspectRatio: 1.0 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScan)
            .catch(err => alert("Camera Error: " + err));
        };
    </script>
</body>
</html>
