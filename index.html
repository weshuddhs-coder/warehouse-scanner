<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Scan</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f5; text-align: center; }
        
        /* SCANNER CONTAINER */
        #reader { width: 100%; background: black; border-radius: 8px; overflow: hidden; }

        /* HEADER */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .val { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .label { font-size: 0.8rem; color: #64748b; }

        /* DEBUG LOG (RED BOX) */
        #debug-log { 
            margin-top: 20px; 
            background: #333; 
            color: #0f0; 
            font-family: monospace; 
            padding: 10px; 
            text-align: left; 
            height: 150px; 
            overflow-y: scroll;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; background: #e2e8f0; border-radius: 8px; font-weight: bold; color: #64748b; cursor: pointer; }
        .tab.active { background: #2563eb; color: white; }
        .tab[data-mode="PICKED_UP"].active { background: #16a34a; }
    </style>
</head>
<body>

    <div class="stats">
        <div class="box"><div class="val" id="ready-count">0</div><div class="label">Ready</div></div>
        <div class="box"><div class="val" id="picked-count">0</div><div class="label">Picked</div></div>
    </div>

    <div class="tabs">
        <div class="tab active" data-mode="READY" onclick="setMode('READY')">MARK READY</div>
        <div class="tab" data-mode="PICKED_UP" onclick="setMode('PICKED_UP')">MARK PICKED</div>
    </div>

    <div id="reader"></div>

    <div id="debug-log">System Initialized...</div>

    <script>
        const BASE_URL = "https://pzgnggkanppnwnkjgwrm.supabase.co/functions/v1";
        const OPERATOR = "WarehouseOps";
        let MODE = 'READY';
        let lastCode = null;

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.innerHTML += `<div>> ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        function setMode(m) {
            MODE = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-mode="${m}"]`).classList.add('active');
            lastCode = null;
        }

        // === 1. INITIALIZE SCANNER ===
        function onScanSuccess(decodedText, decodedResult) {
            if (decodedText === lastCode) return;
            lastCode = decodedText;
            
            log(`SCANNED: ${decodedText}`);
            processScan(decodedText);
        }

        function onScanFailure(error) {
            // This fires continuously when it doesn't see a code. 
            // We ignore it to keep logs clean.
        }

        // Load the Scanner UI
        try {
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { fps: 10, qrbox: { width: 250, height: 150 } }, 
                /* verbose= */ false
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            log("Scanner UI Rendered. Click 'Request Camera Permissions' above.");
        } catch (err) {
            log("CRITICAL ERROR: " + err);
        }

        // === 2. API LOGIC ===
        async function processScan(awb) {
            const endpoint = MODE === 'READY' ? 'warehouse_scan_ready' : 'warehouse_scan_picked_up';
            try {
                const res = await fetch(`${BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ awb: awb, operator: OPERATOR })
                });
                const data = await res.json();
                
                if (data.result === 'ACCEPTED') {
                    log(`✅ SUCCESS: ${data.message}`);
                    document.getElementById(MODE === 'READY' ? 'ready-count' : 'picked-count').innerText++;
                    alert(`✅ OK: ${awb}`);
                } else {
                    log(`❌ REJECTED: ${data.message}`);
                    alert(`⚠️ ERROR: ${data.message}`);
                }
            } catch (e) {
                log(`❌ NETWORK ERROR: ${e.message}`);
            }
        }
    </script>
</body>
</html>
