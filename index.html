<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcodes Only</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* BASE & RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 0; 
            background: #000; 
            height: 100vh; 
            display: flex; flex-direction: column; 
        }

        /* 1. TOP HEADER */
        .header { 
            background: #fff; 
            padding: 10px; 
            z-index: 20; 
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; 
        }

        /* 2x2 STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
        .stat-card { background: #f8fafc; padding: 6px; border-radius: 6px; border: 1px solid #cbd5e1; text-align: center; }
        .stat-card.batch { background: #eff6ff; border-color: #93c5fd; }
        .stat-val { font-size: 1.1rem; font-weight: 800; color: #0f172a; line-height: 1; }
        .stat-label { font-size: 0.6rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-top: 2px; }

        /* TABS */
        .tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 3px; }
        .tab { flex: 1; padding: 8px; text-align: center; font-weight: 700; font-size: 0.8rem; border-radius: 6px; cursor: pointer; color: #64748b; }
        .tab.active { background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.15); color: #000; }
        .tab[data-mode="READY"].active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab[data-mode="PICKED_UP"].active { color: #16a34a; border-bottom: 2px solid #16a34a; }

        /* 2. CAMERA AREA (Fills space) */
        #reader-wrapper { 
            flex: 1; 
            position: relative; 
            background: #000; 
            overflow: hidden; 
        }
        #reader { 
            width: 100%; 
            height: 100%; 
        }
        /* Make the camera video fill the container */
        #reader video { object-fit: cover; width: 100%; height: 100%; }

        /* 3. LOGS (Fixed Bottom Sheet) */
        .logs-container { 
            height: 40vh; /* Increased Size as requested */
            background: white; 
            display: flex; flex-direction: column; 
            z-index: 30;
            border-top-left-radius: 16px; border-top-right-radius: 16px; 
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
        }
        .logs-header { 
            padding: 12px 15px; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .logs-title { font-weight: 800; font-size: 0.85rem; color: #334155; letter-spacing: 0.5px; }
        .btn-reset { 
            background: #f1f5f9; border: 1px solid #cbd5e1; 
            color: #475569; padding: 4px 10px; border-radius: 4px; 
            font-size: 0.7rem; font-weight: bold; 
        }
        .logs-list { flex: 1; overflow-y: auto; padding: 0; }
        .log-row { 
            padding: 10px 15px; border-bottom: 1px solid #f1f5f9; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .log-row.ok { border-left: 5px solid #16a34a; background: #f0fdf4; }
        .log-row.err { border-left: 5px solid #dc2626; background: #fef2f2; }
        
        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .overlay.success { background: rgba(22, 163, 74, 0.9); pointer-events: none; }
        .overlay.error { background: rgba(220, 38, 38, 0.98); color: white; }
        
        .overlay h1 { font-size: 5rem; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .overlay p { font-size: 1.5rem; font-weight: bold; margin: 10px 20px; color: white; }
        
        button.btn-close { 
            margin-top: 30px; padding: 15px 50px; 
            border-radius: 50px; border: none; 
            font-weight: 900; font-size: 1.2rem; 
            background: white; color: black; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="stats-grid">
            <div class="stat-card batch">
                <div class="stat-val" id="b-ready">0</div>
                <div class="stat-label">Batch Ready</div>
            </div>
            <div class="stat-card batch">
                <div class="stat-val" id="b-picked">0</div>
                <div class="stat-label">Batch Picked</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="t-ready">-</div>
                <div class="stat-label">Today Ready</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="t-picked">-</div>
                <div class="stat-label">Today Picked</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-mode="READY" onclick="setMode('READY')">MARK READY</div>
            <div class="tab" data-mode="PICKED_UP" onclick="setMode('PICKED_UP')">MARK PICKED UP</div>
        </div>
    </div>

    <div id="reader-wrapper">
        <div id="reader"></div>
    </div>

    <div class="logs-container">
        <div class="logs-header">
            <span class="logs-title">SCAN HISTORY</span>
            <button class="btn-reset" onclick="resetBatch()">RESET BATCH</button>
        </div>
        <div class="logs-list" id="logs"></div>
    </div>

    <div id="success-overlay" class="overlay success">
        <h1>✅</h1>
        <p id="success-txt">SCANNED</p>
    </div>

    <div id="error-overlay" class="overlay error">
        <h1>⚠️</h1>
        <p id="error-txt">ERROR</p>
        <button class="btn-close" onclick="closeError()">OK</button>
    </div>

    <script>
        // === CONFIG ===
        const BASE_URL = "https://pzgnggkanppnwnkjgwrm.supabase.co/functions/v1"; 
        const OPERATOR = "WarehouseOps";

        // === STATE ===
        let MODE = 'READY';
        let isProcessing = false;
        let lastCode = null;
        let batch = { READY: 0, PICKED_UP: 0 };
        let today = { READY: 0, PICKED_UP: 0 };

        // === AUDIO ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if(type==='ok'){
                osc.frequency.value=1200; gain.gain.value=0.1;
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else {
                osc.type='sawtooth'; osc.frequency.value=150; gain.gain.value=0.5;
                osc.start(); osc.stop(audioCtx.currentTime+0.3);
                if(navigator.vibrate) navigator.vibrate(300);
            }
        }

        // === LOGIC ===
        function setMode(m) {
            MODE = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-mode="${m}"]`).classList.add('active');
            lastCode = null;
        }

        function resetBatch() {
            if(confirm("Clear batch counts?")) {
                batch = { READY: 0, PICKED_UP: 0 };
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('b-ready').innerText = batch.READY;
            document.getElementById('b-picked').innerText = batch.PICKED_UP;
            document.getElementById('t-ready').innerText = today.READY;
            document.getElementById('t-picked').innerText = today.PICKED_UP;
        }

        function addLog(awb, msg, type) {
            const row = document.createElement('div');
            row.className = `log-row ${type}`;
            row.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:1rem; color:#1e293b">${awb.slice(-8)}</div>
                    <div style="font-size:0.75rem; color:#64748b">${msg}</div>
                </div>
                <div style="font-size:0.7rem; color:#94a3b8">${new Date().toLocaleTimeString()}</div>
            `;
            document.getElementById('logs').prepend(row);
        }

        async function fetchCounts() {
            try {
                const res = await fetch(`${BASE_URL}/warehouse_get_counts`);
                const data = await res.json();
                if(data) {
                    today.READY = data.ready_today || 0;
                    today.PICKED_UP = data.picked_today || 0;
                    updateUI();
                }
            } catch(e) {}
        }

        async function onScan(decodedText) {
            if (isProcessing) return;
            if (decodedText === lastCode) return;
            
            isProcessing = true;
            lastCode = decodedText;

            const endpoint = MODE === 'READY' ? 'warehouse_scan_ready' : 'warehouse_scan_picked_up';
            
            try {
                const res = await fetch(`${BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ awb: decodedText, operator: OPERATOR })
                });
                const data = await res.json();

                if (data.result === 'ACCEPTED') {
                    beep('ok');
                    batch[MODE]++; today[MODE]++; updateUI();
                    
                    document.getElementById('success-txt').innerText = `${decodedText}\n${data.message}`;
                    document.getElementById('success-overlay').style.display = 'flex';
                    addLog(decodedText, data.message, 'ok');
                    
                    setTimeout(() => {
                        document.getElementById('success-overlay').style.display = 'none';
                        isProcessing = false;
                        fetchCounts(); // background sync
                    }, 800);
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                beep('err');
                document.getElementById('error-txt').innerText = `${decodedText}\n\n${e.message || "Error"}`;
                document.getElementById('error-overlay').style.display = 'flex';
                addLog(decodedText, e.message || "Error", 'err');
            }
        }

        function closeError() {
            document.getElementById('error-overlay').style.display = 'none';
            isProcessing = false;
            lastCode = null;
        }

        // === INIT ===
        window.onload = function() {
            fetchCounts();
            
            const html5QrCode = new Html5Qrcode("reader");

            // --- CRITICAL CONFIGURATION ---
            // 1. Only scan CODE_128 (AWB) and CODE_39. IGNORES QR!
            const formats = [ 
                Html5QrcodeSupportedFormats.CODE_128, 
                Html5QrcodeSupportedFormats.CODE_39 
            ];

            const config = { 
                fps: 15, 
                qrbox: { width: 300, height: 100 }, // WIDE box for barcodes
                aspectRatio: 1.0,
                formatsToSupport: formats // This enforces "Barcodes Only"
            };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onScan
            ).catch(err => {
                alert("Camera Error: " + err);
            });
        };
    </script>
</body>
</html>
